---
title: "Data Carpentry: Final Project Proposal"
author: "Michelle Kelly"
date: "July 16, 2018"
output: 
  pdf_document:
    fig_caption: true
---

```{r setup, echo = FALSE, warning = FALSE, message = FALSE}
# streamPULSE pipeline tools
#library(devtools)
#install_github('streampulse/StreamPULSE', dependencies=TRUE)

# Latest version of streamMetabolizer
#install.packages("streamMetabolizer", dependencies = TRUE, 
#                 repos = c("https://owi.usgs.gov/R", "https://cran.rstudio.com"))

library(lubridate)
#library(StreamPULSE)
library(streamMetabolizer)
library(imputeTS)
library(ggplot2)
```

# Introduction  

The root of all ecosystems is the sun - and the organisms that harness it's energy. Solar energy provides the fuel that primary producers require, using photosynthesis to transform water and carbon dioxide into metabolizable carbon products... (introduce this as metabolism)  
The conversion rate of solar energy to organic energy is termed gross primary productivity (GPP). The consumption of organic energy, by both autotrophs and heterotrophs, is termed ecosystem respiration (ER). The balance between GPP and ER is referred to as net ecosystem production (NEP), and can ultimately be used as an indicatior of whether a system is retaining or losing carbon.  

The metabolism of terrestrial ecosystems often follows an annual pattern. GPP and NEP usually peak during warm, wet summer months, when conditions are most favorable for photosynthetic growth. Lakes also tend to have peak GPP and NEP in summer, when water is warmest, light availability is greatest, and dissolved nutrient concentrations tend to be greatest.  

In rivers and streams, this pattern doesn't always hold up. Often, light availability decreases in summer, as canopy leaf-out prevents light from reaching surface water. Furthermore, high flow events, caused by rain or snowmelt, scour autotrophs from the streambed. Frequent removal of algae, moss, and macrophytes prevents GPP from reaching theoretical potential. Rivers also recieve considerable carbon input from surrounding terrestrial sources (leaf litter in Fall, organic matter from surrounding watershed). Terrestial carbon input can be equal to or exceed GPP, blurring the seasonal patterns of GPP and ER.  

```{r bernhardt, echo = FALSE, fig.cap="Conceptual yearly hydrographs for rivers experiencing aseasonal rain dynamics, a mid-year monsoon season, and a spring snowmelt (adapted from Bernhardt et al 2018). \\label{bernhardt}", out.height="20%", fig.align = "center"}
knitr::include_graphics("Proposal_images/Bernhardt2018.png")
```

However, all rivers are not created equal. As stream size increases, GPP is less effected by canopy cover and terrestrial carbon input, and their metabolic regimes more closely resemble that of lakes and terrestrial systems. Less is known about the metabolic regimes of aseasonal, tropical systems, where growing conditions may be favorable all year round. [Figure \ref{vannote}].  

```{r vannote, echo = FALSE, fig.cap="The relationship between stream size and stream attributes (adapted from Vannote et al 1980). \\label{vannote}", out.height="30%", fig.align='center'}
knitr::include_graphics("Proposal_images/Vannote1980_edit.png")
```


- change this to making predictions based on river characteristics
- explain why investigating metabolism is important  
- propose some study questions:
- can we see a "metabolic signature" of river characteristics (such as stream size, temperature, canopy cover, ) in this data?
- can we determine what controls the variation and magnitude of productivity within these rivers?  

# Methods  
- describe USGS data and how you collected it
- description of why certain sites were chosen  
    - explain that for the purposes of proposal, model was evaluated for only one of the sites
- description of methods used to model metabolism  

# Results  
- present results of modeling from one site as a preliminary result  
# Discussion  
- connect the results back to metabolism regime work done by bernhardt et al 2018, etc
- describe plans for final project

```{r data.import, cache = TRUE, echo = FALSE, warning = FALSE, message = FALSE}
# for this proposal, pull one USGS site
# full project will do comparison between sites of different conditions: tropical rivers, artic rivers, heavy agricultural rivers, arid rivers

source("dataLoad.R")

# notes for Tests.Rmd
#     verify input is in correct format:
#         - verify column names are as expected

# large, aseasonal, little canopy cover: loading CA sacramento data
filepath_CA <- "./data_files/CA_SacramentoR.csv"
lat_CA <- "38.257778"
long_CA <- "-121.517222"
tz_CA <- "America/Los_Angeles"
CA_SacramentoR <- dataLoad(filepath = filepath_CA, lat = lat_CA, long = long_CA, tz = tz_CA)

# small, seasonal, and forested: loading CT data
filepath_CT <- "./data_files/CT_NorthBranchParkR.csv"
lat_CT <- "41.784439"
long_CT <- "-72.708056"
tz_CT <- "America/New_York"
CT_NorthBranch <- dataLoad(filepath = filepath_CT, lat = lat_CT, long = long_CT, tz = tz_CT)

# large, seasonal, agriculturally dominated: Mississippi R at Clinton IA
# gage # 05420500
filepath_IA <- "./data_files/IA_MississippiR.csv"
lat_IA <- "41.780556"
long_IA <- "-90.251944"
tz_IA <- "America/Chicago"
IA_MississippiR <- dataLoad(filepath = filepath_IA, lat = lat_IA, long = long_IA, tz = tz_IA)
```

```{r dataPrep, echo = FALSE, warning = FALSE, message = FALSE}
# notes for Tests.Rmd
#     verify input is in correct format:
#         - verify column names are as expected
#         - verify column classes are as expected
source("dataPrep.R")
IA_MississippiR <- dataPrep(IA_MississippiR)
```

```{r modeling, cache = TRUE, echo = FALSE, message = FALSE, warning = FALSE}
# notes for Tests.rmd
#     verify input is in correct format:
#       - verify column names are as expected (check that data has passed through dataPrep)
#       - verify no NA values in any columns
source("metabolismModeling.R")
metabModel.IA_MississippiR <- metabolismModeling(IA_MississippiR,
                                                 "IA_MississippiR_MetabolismModel.csv")
```

```{r plotting, fig.height=4, fig.width = 8, echo = FALSE, warning = FALSE}
# have a very short function that plots
source("metabolismPlot.R")
metabolismPlot(metabModel.IA_MississippiR, filename = "IA_MississippiR_MetabolismModel.png") # model is not totally complete, visually check over input data to improve model output. I think this example is fine for the purposes of the proposal, however.
```

# References  
- bernhardt et al 2018