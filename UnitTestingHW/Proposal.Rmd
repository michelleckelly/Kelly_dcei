---
title: "Data Carpentry: Final Project Proposal"
author: "Michelle Kelly"
date: "July 16, 2018"
output: 
  pdf_document:
    fig_caption: true
---

```{r setup, echo = FALSE, warning = FALSE, message = FALSE}
# streamPULSE pipeline tools
#library(devtools)
#install_github('streampulse/StreamPULSE', dependencies=TRUE)

# Latest version of streamMetabolizer
#install.packages("streamMetabolizer", dependencies = TRUE, 
#                 repos = c("https://owi.usgs.gov/R", "https://cran.rstudio.com"))

library(lubridate)
#library(StreamPULSE)
library(streamMetabolizer)
library(imputeTS)
library(ggplot2)
```

# Introduction  

Without photosynthesis, Earth's ecosystems would collapse. Primary producers' conversion of solar energy, water, and carbon dioxide into metabolize sugars forms the foundation of the trophic ladder: supporting both producers and consumers. The conversion rate of solar energy to organic energy within an ecosystem is termed gross primary productivity (GPP), and can be measured as oxygen produced per day. The consumption of this organic energy, by both autotrophs and heterotrophs, is termed ecosystem respiration (ER). The balance between GPP and ER is referred to as net ecosystem production (NEP), and can ultimately be used as an indicator of whether an ecosystem is retaining or losing carbon.  

```{r bernhardt, echo = FALSE, fig.cap="Conceptual yearly hydrographs for rivers experiencing aseasonal rain dynamics, a mid-year monsoon season, and a spring snowmelt (adapted from Bernhardt et al 2018). \\label{bernhardt}", out.height="20%", fig.align = "center"}
knitr::include_graphics("Proposal_images/Bernhardt2018.png")
```

In terrestrial systems, NEP often follows a predictable annual cycle. GPP and NEP tend to peak during warm, wet summer months, when conditions are most favorable for photosynthetic growth. Primary production in lakes usually syncs up with the terrestrial cycle; greater light availability, higher water temperatures, and availible dissolved nutrients create the ideal coctail for algae, moss, and macrophyte growth.  

However, primary production in rivers and streams doesn't often correlate with the terrestrial growing season. In small streams, light availability decreases in summer, as canopy leaf-out prevents light from reaching surface water. Variations in stream flow, which can be caused by rain events, snowmelt, or drought, scour or dessicate stream beds, reducing the biomass of primary producers. Stream hydrology can follow a yearly pattern, but vary widely between biomes [Figure \ref{bernhardt}]. Furthermore, reaches may also recieve a significant carbon input from non-aquatic sources, such as an influx of leaf litter during Autumn, or the flushing of soil-bound organic matter during rain events. Carbon input from terrestrial sources can equal or exceed yearly GPP, blurring the seasonal pattern of GPP and ER.  

As stream size increases, ecosystem productivity is less effected by reach morphology, and more closely follows the terrestrial growing system. In wide, open rivers, canopy cover ceases to be a limiting factor [Figure \ref{vannote}]. Water velocity decreases with increasing channel width, reducing scouring, even under the same hydrologic regimes *Citation*. In large rivers, terrestrial organic matter tends to make up a smaller fraction of the system's total dissolved organic matter *Citation*.  

```{r vannote, echo = FALSE, fig.cap="The relationship between stream size and stream attributes (adapted from Vannote et al 1980). \\label{vannote}", out.height="30%", fig.align='center'}
knitr::include_graphics("Proposal_images/Vannote1980_edit.png")
```

Recently, Bernhardt et. al proposed a conceptual framework of stream "metabolic regimes", suggesting dominant annual patterns of GPP and ER dynamics for river ecosystems subjected to varying physical and biochemical conditions (2018). We propose to "ground-truth" the metabolism regime concept by asking *(1)* if we hold the effects of latitude constant, can we see these patterns in real stream data, and *(2)* can we see a common "signature" of a local condition (such as disturbance, stream size, or land use) in a metabolism model?  

# Methods  
- describe USGS data and how you collected it
- description of why certain sites were chosen  
    - explain that for the purposes of proposal, model was evaluated for only one of the sites
- description of methods used to model metabolism  

# Results  
- present results of modeling from one site as a preliminary result  
# Discussion  
- connect the results back to metabolism regime work done by bernhardt et al 2018, etc
- describe plans for final project

```{r data.import, cache = TRUE, echo = FALSE, warning = FALSE, message = FALSE}
# for this proposal, pull one USGS site
# full project will do comparison between sites of different conditions: tropical rivers, artic rivers, heavy agricultural rivers, arid rivers

source("dataLoad.R")

# notes for Tests.Rmd
#     verify input is in correct format:
#         - verify column names are as expected

# large, aseasonal, little canopy cover: loading CA sacramento data
filepath_CA <- "./data_files/CA_SacramentoR.csv"
lat_CA <- "38.257778"
long_CA <- "-121.517222"
tz_CA <- "America/Los_Angeles"
CA_SacramentoR <- dataLoad(filepath = filepath_CA, lat = lat_CA, long = long_CA, tz = tz_CA)

# small, seasonal, and forested: loading CT data
filepath_CT <- "./data_files/CT_NorthBranchParkR.csv"
lat_CT <- "41.784439"
long_CT <- "-72.708056"
tz_CT <- "America/New_York"
CT_NorthBranch <- dataLoad(filepath = filepath_CT, lat = lat_CT, long = long_CT, tz = tz_CT)

# large, seasonal, agriculturally dominated: Mississippi R at Clinton IA
# gage # 05420500
filepath_IA <- "./data_files/IA_MississippiR.csv"
lat_IA <- "41.780556"
long_IA <- "-90.251944"
tz_IA <- "America/Chicago"
IA_MississippiR <- dataLoad(filepath = filepath_IA, lat = lat_IA, long = long_IA, tz = tz_IA)
```

```{r dataPrep, echo = FALSE, warning = FALSE, message = FALSE}
# notes for Tests.Rmd
#     verify input is in correct format:
#         - verify column names are as expected
#         - verify column classes are as expected
source("dataPrep.R")
IA_MississippiR <- dataPrep(IA_MississippiR)
```

```{r modeling, cache = TRUE, echo = FALSE, message = FALSE, warning = FALSE}
# notes for Tests.rmd
#     verify input is in correct format:
#       - verify column names are as expected (check that data has passed through dataPrep)
#       - verify no NA values in any columns
source("metabolismModeling.R")
metabModel.IA_MississippiR <- metabolismModeling(IA_MississippiR,
                                                 "IA_MississippiR_MetabolismModel.csv")
```

```{r plotting, fig.height=4, fig.width = 8, echo = FALSE, warning = FALSE}
# have a very short function that plots
source("metabolismPlot.R")
metabolismPlot(metabModel.IA_MississippiR, filename = "IA_MississippiR_MetabolismModel.png") # model is not totally complete, visually check over input data to improve model output. I think this example is fine for the purposes of the proposal, however.
```

# References  
- bernhardt et al 2018