---
title: "ModularityHW_Kelly"
author: "Michelle Kelly"
date: "June 4, 2018"
output: 
  pdf_document:
    theme: yeti
    df_print: paged
    toc: yes
    number_sections: true
---  
<!-- MODULARITY LESSON 8: note exact purpose of each Rmd chunk-->
<!-- R setup chunk -->
```{r setup, echo=FALSE, message=FALSE, error=FALSE, warning=FALSE}
### Global options ###
knitr::opts_chunk$set(fig.height = 5, fig.width = 9, cache=TRUE)
# Enable caching in all chunks
# Set default size of figures to 5x7

### Packages ###
library(ggplot2)
library(data.table)
library(reshape2)
library(maps)
library(maptools)
library(dplyr)
```

***  

# Abstract  

(you will have to write this) climate change, long term trends, etc  

***  

# Introduction  

research questions:  
(1) can we see climate warming for ourselves by analyzing this data?  
(2) in what parts of the country are temperatures getting warmer? are there parts of the country where temperatures became colder?  
(3) can we say, based on this data, what change has occured in precipitation over the period?  

***

# Methods  

***

# Results  

```{r dataImport, echo=FALSE}
# Dependencies: 
#     USAAnnualPcpn1950_2008.rds
#     USAAnnualTemp1950_2008.rds

provided <- TRUE
# provided <- TRUE if data loaded from file, FALSE if data pulled from API

if (provided == TRUE){
  precip <- readRDS(file = "USAAnnualPcpn1950_2008.rds")
  # precip <- annual precipitation data for USA
  temp <- readRDS(file = "USAAnnualTemp1950_2008.rds")
  # temp <- annual temperature data for USA
}
```

```{r dataCleanup, echo=FALSE}
### MODULARITY LESSON 1: variables, not constants ###
minYears <- 40
# minYears <- minimum years of data each station must have to be included in analysis

### MODULARITY LESSON 7: Pseudocode for trimming function ###
# trim <- function(dataset, minimumTimespan){
#   exclude years that have no data
#   count number of years of data for each station
#   if (years of data <= 40){
#     exclude station from dataframe
#   }
#   return(dataframe)
# }

### MODULARITY LESSON 2: write extensible code by creating trimming function ###

cleanByYear <- function(dataframe, nYears){
  # get rid of all NA data, so the number of entries will equal the number of years of data 
  dataframe <- na.exclude(dataframe)
  # add a count column, to count the number of years of data for each site
  dataframe$count <- table(dataframe$name)[dataframe$name]
  # if count is less than number of desired years, NA data
  for (row in 1:nrow(dataframe)){
    if (dataframe$count[row] <= nYears){
      dataframe[row,] <- NA
    }
  }
  # remove NA data from dataframe
  dataframe <- na.exclude(dataframe)
  # return dataframe without count column
  dataframe$count <- NULL
  return(dataframe)
}

precip <- cleanByYear(precip, minYears)
temp <- cleanByYear(temp, minYears)
```

```{r dataAnalysis, echo = FALSE}
precip_summary <- data.frame(year = precip$year, 
                             data = precip$data)
precip %>% group_by(year) %>% summarize(mean_precip = mean(data), sd_precip = sd(data))

yearlyStatistics <- function(dataframe){
  dataframe %>% group_by(year) %>% summarize(mean = mean(data), sd = sd(data))
}

precip_summary <- yearlyStatistics(precip)
temp_summary <- yearlyStatistics(temp)
```

```{r dataVis_temp, echo=FALSE}
ggplot(data = precip_summary, aes(x = year, y = mean)) +
  geom_line() + geom_point() +
  geom_smooth(method = "lm") +
  #geom_errorbar(aes(ymax = mean+sd, ymin = mean-sd)) +
  xlab("Year") + ylab("Mean precipitation (in)") +
  theme_classic()

ggplot(data = temp_summary, aes(x = year, y = mean)) +
  geom_line() + geom_point() +
  geom_smooth(method = "lm") +
  #geom_errorbar(aes(ymax = mean+sd, ymin = mean-sd)) +
  xlab("Year") + ylab("Mean temperature (F)") +
  theme_classic()



# significance testing: does basic trend change with time?
str(na.omit(temp))
signiftest_temp <- lm(na.omit(temp)$data ~ na.omit(temp)$year)
summary(signiftest_temp)

# average trend
temp_means <- rowMeans(temp_matrix, na.rm = TRUE)
str(temp_means)

# plotting data with trendline
matplot(x = names(temp_matrix[,1]), y = temp_matrix,
        type = "l", xlab = "Year", ylab = "Average annual temperature (degrees F)",
        ylim = c(0,100), col = rgb(0, (1:10)/10, 0))
par(new = TRUE)
plot(x = names(temp_means), y = temp_means, ylim = c(0,100), ann = FALSE,
     type = "l", axes = FALSE, col = "white", lwd = 4)
par(new = FALSE)

#usa <- map_data("usa")




```

```{r dataVis_precip, echo=FALSE}
# significance testing: does basic trend change with time?
signiftest_precip <- lm(precip$data ~ precip$year)
summary(signiftest_precip)

# plotting data with trendline
matplot(x = names(precip_matrix[,1]), y = precip_matrix, 
        type = "l", xlab = "Year", ylab = "Average annual precipitation (inches)",
        col = rgb(0, 0, (1:10)/10))
abline(signiftest_precip, col = "red", lwd = 2)
```

# Discussion

# References
