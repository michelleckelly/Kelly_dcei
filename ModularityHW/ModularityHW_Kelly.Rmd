---
title: "ModularityHW_Kelly"
author: "Michelle Kelly"
date: "June 4, 2018"
output: 
  pdf_document:
    theme: yeti
    df_print: paged
    toc: yes
    number_sections: true
    fig_caption: yes
---  
<!-- MODULARITY LESSON 8: have defined purpose for each Rmd chunk-->
```{r setup, echo=FALSE, message=FALSE, error=FALSE, warning=FALSE}
# Global options
knitr::opts_chunk$set(fig.height = 5, fig.width = 15, cache=TRUE) 
# Enable caching in all chunks, Set default size of figures to 5x9

# Packages
library(dplyr)
library(data.table)
library(ggplot2)
library(maps)
library(maptools)
library(mapdata)
library(viridis)
library(grid)
library(gridExtra)
```

***  

# Abstract  

(you will have to write this) climate change, long term trends, etc  

***  

# Introduction  

research questions:  
(1) can we see climate warming for ourselves by analyzing this data?  
(2) in what parts of the country are temperatures getting warmer? are there parts of the country where temperatures became colder?  
(3) can we say, based on this data, what change has occured in precipitation over the period?  

***

# Methods  

***

# Results  

```{r dataImport, echo=FALSE}
# Dependencies: 
#     USAAnnualPcpn1950_2008.rds
#     USAAnnualTemp1950_2008.rds

provided <- TRUE # TRUE if data loaded from file, FALSE if data pulled from API

if (provided == TRUE){
  precip <- readRDS(file = "USAAnnualPcpn1950_2008.rds") # annual precipitation data for USA
  temp <- readRDS(file = "USAAnnualTemp1950_2008.rds") # annual temperature data for USA
}
```

```{r dataCleanup, echo=FALSE}
# MODULARITY LESSON 1: variables, not constants
minYears <- 40 # minimum years of data for each station

# MODULARITY LESSON 7: Pseudocode for trimming function

# trim <- function(dataset, minimumTimespan){
#   exclude years that have no data
#   count number of years of data for each station
#   if (years of data <= 40){
#     exclude station from dataframe
#   }
#   return(dataframe)
# }

# MODULARITY LESSON 2: write extensible code by creating trimming function

cleanByYear <- function(dataframe, nYears){
  dataframe <- na.exclude(dataframe)
  dataframe$count <- table(dataframe$name)[dataframe$name]
  for (row in 1:nrow(dataframe)){
    if (dataframe$count[row] <= nYears){
      dataframe[row,] <- NA
    }
  }
  dataframe <- na.exclude(dataframe)
  dataframe$count <- NULL
  return(dataframe)
}

precip <- cleanByYear(precip, minYears)
temp <- cleanByYear(temp, minYears)
```

```{r dataAnalysis, echo = FALSE}
# yearlyStatistics: mean data across USA for each year
yearlyStatistics <- function(dataframe){
  dataframe %>% group_by(year) %>% summarize(mean = mean(data))
}

precip_summary <- yearlyStatistics(precip)
temp_summary <- yearlyStatistics(temp)

# stateStatistics: mean data across each state for each year

# stateStatistics pseudocode:
#   1. compute overall average, so we can compare values to the average
#   2. group the data by year and state
#   3. compute the mean, standard deviation, and difference of values from the yearly average
#       where negative difference values represent colder/less rain than average
#       positive values represent warmer/more rain than average

stateStatistics <- function(dataframe){
  dataframe_state <- 
    dataframe %>% 
      group_by(year, state) %>% 
      summarize(mean = mean(data))
  
  dataframe_statesummary <- 
    dataframe_state %>%
      group_by(state) %>%
      summarise(state_mean = mean(mean))
  
  dataframe_merge <- 
    merge(dataframe_state, dataframe_statesummary, by = "state")
}

precip_state <- stateStatistics(precip)
temp_state <- stateStatistics(temp)

# deviation: compute difference between state yearly average and state overall (1950-2008) average
deviation <- function(dataset_state){
  dataset_state$mean - dataset_state$state_mean
}

precip_state$change <- deviation(precip_state)
temp_state$change <- deviation(temp_state)

# timeseries.change: compute mean deviation from state overall average across 1950-2008
timeseries.change <- function(dataset_state){
  dataset_state %>%
    group_by(state) %>%
    summarize(sum.change = sum(change))
}

precip.timeseries.change <- timeseries.change(precip_state)
temp.timeseries.change <- timeseries.change(temp_state)

# data for mapping: plot mean deviation from average over last century of data (1998-2008) compared to mean deviation from average during 1950-1960
temp.change <- function(dataset, minYear, maxYear){
  dataset %>%
    group_by(state, year) %>%
    filter(year >= minYear & year <= maxYear) %>%
    group_by(state) %>%
    summarize(mean.change = mean(change)) 
}

temp.change.1950.1960 <- temp.change(temp_state, minYear = 1950, maxYear = 1960)
temp.change.1998.2008 <- temp.change(temp_state, minYear = 1998, maxYear = 2008)
```


```{r dataVis_overallPlot, echo=FALSE, include=FALSE}
# yearlyPlot: simple plot of yearly means, with added trendline
yearlyPlot <- function(dataset, ylabel, ...){
  ggplot(data = dataset, aes(x = year, y = mean, ...)) +
  geom_line() + geom_point() +
  geom_smooth(method = "lm") +
  xlab("Year") + ylab(ylabel) +
  theme_classic()
}

yearlyPlot(precip_summary, ylabel = "Yearly averaged precipitation (in)")
yearlyPlot(temp_summary, ylabel = "Yearly averaged temperature (F)")

```

```{r dataVis_functions, echo = FALSE}
# heatmap: visualization of change through time using colored tiles
heatmap <- function(dataset, legendlabel, ...){
  ggplot(dataset, aes(x = state, y = year, ...)) +
  geom_tile(aes(fill = change), color = "white") +
  scale_fill_distiller(type = "div", palette = 7, name = legendlabel) +
  xlab("State") + ylab("Year") +
  theme_classic() +
  theme(legend.position = "bottom")
}

# change.barplot: visualization of change through time using bars
change.barplot <- function(dataset_state, ylabel, col_number, ...){
  ggplot(dataset_state, aes(x = year, y = change, ...)) +
    geom_col(aes(fill = change)) +
    facet_wrap(~ state, ncol = col_number) +
    scale_fill_distiller(type = "div", palette = 7) +
    xlab("Year") + ylab(ylabel) +
    theme_classic() +
    theme(panel.background = element_rect(color = "black"),
          legend.position = "none")
}
```

```{r heatmap_temp, echo=FALSE, fig.width = 12, fig.height = 5, fig.cap="\\label{fig:figs}Anomalies in annual mean temperature, relative to 1950-2008 state average"}

# Anomalies in annual mean temperature, relative to 1950-2008 state average
heatmap(temp_state, legendlabel = "Temperature change (°F)")
```

```{r heatmap_precip, echo=FALSE, fig.width = 15, fig.height = 5, fig.cap="\\label{fig:figs}Anomalies in annual precipitation, relative to 1950-2008 state average"}

# Anomalies in annual precipitation, relative to 1950-2008 state average
grid.arrange(
  heatmap(precip_state, legendlabel = "Precipitation 
change (in)"),
  change.barplot(precip_state, ylabel = "Precipitation change (in)", col_number = 3),
  layout_matrix = rbind(c(1,2,2,2),
                        c(1,2,2,2))
)
```

```{r mapping, echo = FALSE}
states <- map_data("state")

# state data is formatted differently in each dataframe, we need this to match so we can join dataframes
states$region <- toupper(states$region)
setnames(states, "region", "state")

# state.convert: using built-in r datasets to convert from state abbreviations to state names
state.convert <- function(dataframe_column){
  toupper(state.name[match(dataframe_column, state.abb)])
}

temp.change.1950.1960$state <- state.convert(temp.change.1950.1960$state)
temp.change.1998.2008$state <- state.convert(temp.change.1998.2008$state)

# join dataframes
temp.change.1950.1960 <- inner_join(states, temp.change.1950.1960, by = "state")
temp.change.1998.2008 <- inner_join(states, temp.change.1998.2008, by = "state")

# plot the two datasets
ggplot(data = temp.change.1950.1960) +
  geom_polygon(aes(x = long, y = lat, group = group, fill = mean.change), 
               color = "white") +
  scale_fill_distiller(type = "div", palette = 7,
                       name = "Temperature change (°F)   ") +
  coord_fixed(1.3) +
  theme_minimal()

ggplot(data = temp.change.1998.2008) +
  geom_polygon(aes(x = long, y = lat, group = group, fill = mean.change), 
               color = "white") +
  coord_fixed(1.3) +
  scale_fill_distiller(limits = c(-2,2),
                       type = "div", palette = 7, 
                       name = "Temperature change (°F)   ") +
  theme_classic() +
  theme(legend.position = "bottom",
        axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        axis.line = element_blank())

mapping <- function(map_dataset, limit_vec){
  ggplot(data = map_dataset) +
    geom_polygon(aes(x = long, y = lat, group = group, fill = mean.change), 
                 color = "white") +
    coord_fixed(1.3) +
    scale_fill_distiller(limits = limit_vec, 
                        type = "seq", palette = 7, direction = 1,
                         name = "Temperature change (°F)   ") +
    theme_classic() +
    theme(legend.position = "bottom",
        axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        axis.line = element_blank())
}

mapping(temp.change.1998.2008, limit_vec = c(0,1.5))

```


```{r significance_testing, echo = FALSE}
# significance testing: yearly means
sigtest_precip <- lm(precip_summary$mean ~ precip_summary$year)
summary(sigtest_precip) # not signif

sigtest_temp <- lm(temp_summary$mean ~ temp_summary$year)
summary(sigtest_temp) # not signif

# significance testing: change by state
summary(lm(temp_state$change ~ temp_state$year)) # signif

summary(lm(precip_state$change ~ precip_state$year)) #signif
```

# Discussion

# References

# Supplemental

```{r barplot_temp, echo = FALSE, fig.width = 17, fig.height = 17, fig.cap = "\\label{fig:figs}Anomalies in annual mean temperature, relative to 1950-2008 state average"}
change.barplot(temp_state, ylabel = "Temperature change (°F)", col_number = 5)
```







