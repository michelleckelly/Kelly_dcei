---
title: "ModularityHW_Kelly"
author: "Michelle Kelly"
date: "June 4, 2018"
output: 
  pdf_document:
    theme: yeti
    df_print: paged
    toc: yes
    number_sections: true
---  
<!-- MODULARITY LESSON 8: have defined purpose for each Rmd chunk-->
```{r setup, echo=FALSE, message=FALSE, error=FALSE, warning=FALSE}
# Global options
knitr::opts_chunk$set(fig.height = 5, fig.width = 15, cache=TRUE) 
# Enable caching in all chunks, Set default size of figures to 5x9

# Packages
library(dplyr)
library(data.table)
library(ggplot2)
library(maps)
library(maptools)
library(mapdata)
library(viridis)
```

***  

# Abstract  

(you will have to write this) climate change, long term trends, etc  

***  

# Introduction  

research questions:  
(1) can we see climate warming for ourselves by analyzing this data?  
(2) in what parts of the country are temperatures getting warmer? are there parts of the country where temperatures became colder?  
(3) can we say, based on this data, what change has occured in precipitation over the period?  

***

# Methods  

***

# Results  

```{r dataImport, echo=FALSE}
# Dependencies: 
#     USAAnnualPcpn1950_2008.rds
#     USAAnnualTemp1950_2008.rds

provided <- TRUE # TRUE if data loaded from file, FALSE if data pulled from API

if (provided == TRUE){
  precip <- readRDS(file = "USAAnnualPcpn1950_2008.rds") # annual precipitation data for USA
  temp <- readRDS(file = "USAAnnualTemp1950_2008.rds") # annual temperature data for USA
}
```

```{r dataCleanup, echo=FALSE}
# MODULARITY LESSON 1: variables, not constants
minYears <- 40 # minimum years of data for each station

# MODULARITY LESSON 7: Pseudocode for trimming function

# trim <- function(dataset, minimumTimespan){
#   exclude years that have no data
#   count number of years of data for each station
#   if (years of data <= 40){
#     exclude station from dataframe
#   }
#   return(dataframe)
# }

# MODULARITY LESSON 2: write extensible code by creating trimming function

cleanByYear <- function(dataframe, nYears){
  dataframe <- na.exclude(dataframe)
  dataframe$count <- table(dataframe$name)[dataframe$name]
  for (row in 1:nrow(dataframe)){
    if (dataframe$count[row] <= nYears){
      dataframe[row,] <- NA
    }
  }
  dataframe <- na.exclude(dataframe)
  dataframe$count <- NULL
  return(dataframe)
}

precip <- cleanByYear(precip, minYears)
temp <- cleanByYear(temp, minYears)
```

```{r dataAnalysis, echo = FALSE}
# yearlyStatistics: mean data across USA for each year
yearlyStatistics <- function(dataframe){
  dataframe %>% group_by(year) %>% summarize(mean = mean(data))
}

precip_summary <- yearlyStatistics(precip)
temp_summary <- yearlyStatistics(temp)

# stateStatistics: mean data across each state for each year

# stateStatistics pseudocode:
#   1. compute overall average, so we can compare values to the average
#   2. group the data by year and state
#   3. compute the mean, standard deviation, and difference of values from the yearly average
#       where negative difference values represent colder/less rain than average
#       positive values represent warmer/more rain than average

stateStatistics <- function(dataframe){
  dataframe_state <- 
    dataframe %>% 
      group_by(year, state) %>% 
      summarize(mean = mean(data))
  
  dataframe_statesummary <- 
    dataframe_state %>%
      group_by(state) %>%
      summarise(state_mean = mean(mean))
  
  dataframe_merge <- 
    merge(dataframe_state, dataframe_statesummary, by = "state")
}

precip_state <- stateStatistics(precip)
temp_state <- stateStatistics(temp)

# deviation: compute difference between state yearly average and state overall (1950-2008) average
deviation <- function(dataset){
  dataset$mean - dataset$state_mean
}

precip_state$change <- deviation(precip_state)
temp_state$change <- deviation(temp_state)
```

```{r dataVisualization, echo=FALSE}
# yearlyPlot: simple plot of yearly means, with added trendline
yearlyPlot <- function(dataset, ylabel, ...){
  ggplot(data = dataset, aes(x = year, y = mean, ...)) +
  geom_line() + geom_point() +
  geom_smooth(method = "lm") +
  xlab("Year") + ylab(ylabel) +
  theme_classic()
}

yearlyPlot(precip_summary, ylabel = "USA mean precipitation (in)")
yearlyPlot(temp_summary, ylabel = "USA mean temperature (F)")

# heatmap: a non-map breakdown of state time series data
heatmap <- function(dataset, plottitle, legendlabel, ...){
  ggplot(dataset, aes(x = state, y = year, ...)) +
  geom_tile(aes(fill = change), color = "white") +
  scale_fill_distiller(type = "div", palette = 4, name = legendlabel) +
  xlab("State") + ylab("Year") + ggtitle(plottitle) +
  theme_classic()
}

heatmap(temp_state, legendlabel = "Temperature change °F",
        plottitle = "Difference in annual mean temperature, relative to 1950-2008 state mean")

heatmap(precip_state, legendlabel = "Precipitation change (in)",
        plottitle = "Difference in annual precipitation, relative to 1950-2008 state mean")

# mapping

```

```{r significance_testing, echo = FALSE}
# significance testing: yearly means
sigtest_precip <- lm(precip_summary$mean ~ precip_summary$year)
summary(sigtest_precip) # not signif

sigtest_temp <- lm(temp_summary$mean ~ temp_summary$year)
summary(sigtest_temp) # not signif

# significance testing: change by state
summary(lm(temp_state$change ~ temp_state$year)) # signif

summary(lm(precip_state$change ~ precip_state$year)) #signif
```





# Discussion

# References
