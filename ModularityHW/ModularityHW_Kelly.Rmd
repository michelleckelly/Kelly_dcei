---
title: "ModularityHW_Kelly"
author: "Michelle Kelly"
date: "June 4, 2018"
output: 
  pdf_document:
    theme: yeti
    df_print: paged
    toc: yes
    number_sections: true
---  
<!-- MODULARITY LESSON 8: note exact purpose of each Rmd chunk-->
<!-- R setup chunk -->
```{r setup, echo=FALSE, message=FALSE, error=FALSE, warning=FALSE}
### Global options ###
# Enable caching in all chunks
# Set default size of figures to 5x7
knitr::opts_chunk$set(fig.height = 5, fig.width = 9, cache=TRUE)

### Packages ###
library(ggplot2)
library(data.table)
library(reshape2)
library(maps)
library(maptools)
```

***  

# Abstract  

(you will have to write this) climate change, long term trends, etc  

***  

# Introduction  

research questions:  
(1) can we see climate warming for ourselves by analyzing this data?  
(2) in what parts of the country are temperatures getting warmer? are there parts of the country where temperatures became colder?  
(3) can we say, based on this data, what change has occured in precipitation over the period?  

***

# Methods  

***

# Results  

```{r dataImport, echo=FALSE}
# Dependencies: 
#   Text files:
#     USAAnnualPcpn1950_2008.rds
#     USAAnnualTemp1950_2008.rds

# Variable definitions: 
#     precip <- annual precipitation data for USA, loaded from USAAnnualPcpn1950_2008.rds
#     temp <- annual temperature data for USA, loaded from USAAnnualTemp1950_2008.rds
#     provided <- TRUE if data loaded from file, 
#                 FALSE if data pulled from API

provided <- TRUE # (modularity lesson #1)

if (provided == TRUE){
  precip <- readRDS(file = "USAAnnualPcpn1950_2008.rds")
  temp <- readRDS(file = "USAAnnualTemp1950_2008.rds")
}
```

```{r dataCleanup, echo=FALSE}
# Dependencies:
#     dataImport

# Function: matricize
# Purpose: convert data frame into matrix from, pre-processing before cleaning data
# Input:
# dataframe     
#   dataframe of either temperature or precipitation data from given files
# Return:
# dataframe
#   matrix of years (rows) and sites (colums) filled with either temp or precip data

matricize <- function(dataframe){
  dataframe <- matrix(data = dataframe$data,
                             nrow = length(unique(dataframe$year)),
                             ncol = length(unique(dataframe$name)),
                             dimnames = list(unique(dataframe$year),
                                             unique(dataframe$name)))
  return(dataframe)
}

precip_matrix <- matricize(precip)
temp_matrix <- matricize(temp)

# Function: trim
# Purpose: subset data, keeping only sites with more than minumum number of years of data
# Input variables:
#     minimumTimespan <- numeric, minimum years of data each station must have
#     dataset <- the data.frame that you want to trim
#     minTime <- minimum years of data each station must have
# Inner variables:
#     trimmedDataframe <- skeleton dataframe, to be filled by trim function
# Output variables:
#     trimmedDataframe <- data.frame of stations that have data for >= minTime

### MODULARITY LESSON 1: variables, not constants ###
minimumTimespan <- 40 # years

### MODULARITY LESSON 7: Pseudocode for trimming function ###
# trim <- function(dataset, minimumTimespan){
#   for (each unique station){
#     find out how many years of data that station has:
#       count number of non-NA values in $data 
#     if (years of data > 40){
#       trimmedDataframe <- (add unique station to dataframe)
#     }
#   }
# return(trimmedDataframe)
# }

### MODULARITY LESSON 2: write extensible code by creating trimming function ###
#trim <- function(dataset, minTime){
  #for(i in 1:ncol(dataset)){
    #if (length(na.omit(dataset[,i])) <= minTime){
      #dataset <- dataset[,-i]
      #i <- i + 1
#    }
#  }
#  return(dataset)
#}

yearsofdata_precip <- colSums(!is.na(precip_matrix))
for (i in 1:ncol(precip_matrix)){
  if (yearsofdata_precip[i] <= 40){
  precip_matrix <- precip_matrix[,-i]
  }
}

yearsofdata_temp <- colSums(!is.na(temp_matrix))
for (i in 1:ncol(temp_matrix)){
  if (yearsofdata_temp[i] <= 40){
  temp_matrix <- temp_matrix[,-i]
  }
}
ncol(temp_matrix)
yearsofdata_temp
```

```{r dataVis_temp, echo=FALSE}
# significance testing: does basic trend change with time?
str(na.omit(temp))
signiftest_temp <- lm(na.omit(temp)$data ~ na.omit(temp)$year)
summary(signiftest_temp)

# average trend
temp_means <- rowMeans(temp_matrix, na.rm = TRUE)
str(temp_means)

# plotting data with trendline
matplot(x = names(temp_matrix[,1]), y = temp_matrix,
        type = "l", xlab = "Year", ylab = "Average annual temperature (degrees F)",
        ylim = c(0,100), col = rgb(0, (1:10)/10, 0))
par(new = TRUE)
plot(x = names(temp_means), y = temp_means, ylim = c(0,100), ann = FALSE,
     type = "l", axes = FALSE, col = "white", lwd = 4)
par(new = FALSE)

usa <- map_data("usa")
```

```{r dataVis_precip, echo=FALSE}
# significance testing: does basic trend change with time?
signiftest_precip <- lm(precip$data ~ precip$year)
summary(signiftest_precip)

# plotting data with trendline
matplot(x = names(precip_matrix[,1]), y = precip_matrix, 
        type = "l", xlab = "Year", ylab = "Average annual precipitation (inches)",
        col = rgb(0, 0, (1:10)/10))
abline(signiftest_precip, col = "red", lwd = 2)
```

# Discussion

# References
